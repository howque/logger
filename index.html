<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Workout Logger</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #121212; color: #e0e0e0; margin: 0; padding: 15px; font-size: 16px;
        }
        .container { max-width: 600px; margin: 0 auto; }
        h2 { text-align: center; margin: 15px 0; font-size: 24px; color: #fff; }

        .section {
            background: #1e1e1e; border: 1px solid #333; border-radius: 12px;
            padding: 15px; margin: 15px 0;
        }
        .section-title {
            font-weight: 600; color: #33aaff; margin-bottom: 12px; font-size: 18px;
        }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }

        .btn {
            background: #2c2c2c; color: #e0e0e0; border: 2px solid #444;
            padding: 20px; border-radius: 10px; cursor: pointer; font-size: 18px;
            font-weight: 600; text-align: center; min-height: 70px; display: flex;
            align-items: center; justify-content: center; transition: all 0.2s;
        }
        .btn:active { background: #444; }
        .btn.selected { background: #007bff; border-color: #007bff; color: #fff; }
        .btn.green { background: #28a745; border-color: #28a745; color: #fff; }
        .btn.red { background: #dc3545; border-color: #dc3545; color: #fff; }
        .btn.orange { background: #fd7e14; border-color: #fd7e14; color: #fff; }

        .counter { display: flex; align-items: center; justify-content: center; gap: 15px; margin: 15px 0; }
        .counter-btn {
            background: #444; color: #fff; border: none; border-radius: 50%;
            width: 60px; height: 60px; font-size: 32px; line-height: 60px; cursor: pointer;
        }
        .counter-display {
            background: #007bff; color: #fff; padding: 15px 30px; border-radius: 8px;
            font-size: 32px; font-weight: 700; min-width: 80px; text-align: center;
        }

        #startBtn {
            width: 100%; padding: 30px; font-size: 24px; border-radius: 15px;
            margin: 20px 0; min-height: 100px; font-weight: 700;
        }
        #startBtn:disabled { background: #444; color: #777; border-color: #555; cursor: not-allowed; }
        #startBtn.recording { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.02); opacity: 0.7; } }

        .sensor-status { display: flex; justify-content: space-around; font-size: 16px; }
        .sensor-dot { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
        .sensor-dot.active { background: #28a745; }
        .sensor-dot.inactive { background: #dc3545; }

        .post-workout {
            background: #1e1e1e; border: 3px solid #fd7e14; border-radius: 15px;
            padding: 25px; margin: 25px 0; display: none;
        }
        .post-workout.show { display: block; }
        .post-workout h3 { color: #fd7e14; text-align: center; margin-top: 0; margin-bottom: 20px; font-size: 24px; }

        #status {
            background: #2a2a2a; border: 1px solid #444; padding: 15px; border-radius: 8px;
            text-align: center; margin: 15px 0; font-size: 18px; min-height: 54px;
        }
        
        .error-message {
            background: #dc3545; color: white; padding: 10px; border-radius: 8px;
            margin: 10px 0; font-size: 14px; display: none;
        }
        
        .recording-indicator {
            position: fixed; top: 20px; right: 20px; background: #dc3545;
            color: white; padding: 10px 15px; border-radius: 8px; font-weight: bold;
            display: none; z-index: 1000; animation: pulse 1s infinite;
        }
        
        .calibration-indicator {
            position: fixed; top: 20px; right: 20px; background: #ffc107;
            color: black; padding: 10px 15px; border-radius: 8px; font-weight: bold;
            display: none; z-index: 1000;
        }

        #debugPanel {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(0,0,0,0.9); border-top: 1px solid #444;
            max-height: 150px; overflow-y: scroll; padding: 10px;
            font-family: monospace; font-size: 12px; display: none; z-index: 100;
        }
        #debugPanel div { margin-bottom: 5px; }
        #debugPanel .time { color: #00aaff; }
        #debugPanel .info { color: #e0e0e0; }
        #debugPanel .error { color: #ff4d4d; font-weight: bold; }

    </style>
</head>
<body>
    <div class="container">
        <h2>üèãÔ∏è Workout Logger</h2>

        <div class="section">
            <div class="section-title">1. Phone Position</div>
            <div class="grid-2">
                <button class="btn" id="upperBtn">Upper Arm</button>
                <button class="btn" id="forearmBtn">Forearm</button>
            </div>
        </div>
        
        <div class="section">
            <div class="section-title">2. Muscle Group</div>
            <div class="grid-2" id="muscleGrid"></div>
        </div>

        <div class="section" id="exerciseSection" style="display: none;">
            <div class="section-title">3. Exercise</div>
            <div class="grid-2" id="exerciseGrid"></div>
        </div>

        <div class="section" id="repSection" style="display: none;">
            <div class="section-title">4. Planned Reps</div>
            <div class="counter">
                <button class="counter-btn" id="repMinusBtn">‚àí</button>
                <div class="counter-display" id="repDisplay">10</div>
                <button class="counter-btn" id="repPlusBtn">+</button>
            </div>
            <div class="grid-4" id="quickRepBtns">
                <button class="btn">8</button><button class="btn">10</button>
                <button class="btn">12</button><button class="btn">15</button>
            </div>
        </div>

        <div id="status">Select Position & Muscle Group</div>
        
        <div class="error-message" id="errorMessage">
            ‚ö†Ô∏è Sensor error: No motion sensors available on this device.
        </div>

        <button id="startBtn" class="btn" disabled>SELECT CONFIGURATION</button>

        <div class="post-workout" id="postWorkout">
            <h3>‚úÖ Confirm Reps</h3>
            <div class="counter">
                <button class="counter-btn btn red" id="actualRepMinusBtn">‚àí</button>
                <div class="counter-display" id="actualRepDisplay">10</div>
                <button class="counter-btn btn green" id="actualRepPlusBtn">+</button>
            </div>
            <div class="grid-4" style="margin: 20px 0;" id="quickActualRepBtns">
                 <button class="btn">8</button><button class="btn">10</button>
                 <button class="btn">12</button><button class="btn">15</button>
            </div>
            <div style="text-align: center;">
                <button class="btn green" id="saveSetBtn" style="width: 100%; font-size: 20px; padding: 25px;">üíæ SAVE SET</button>
            </div>
        </div>
        
        <div class="section">
            <div class="section-title">üìä Sensors</div>
            <div class="sensor-status">
                <span><span class="sensor-dot inactive" id="accDot"></span>Accelerometer</span>
                <span><span class="sensor-dot inactive" id="gyroDot"></span>Gyroscope</span>
                <span><span class="sensor-dot inactive" id="magDot"></span>Magnetometer</span>
            </div>
        </div>

        <div class="section">
            <div class="section-title">üìà Session</div>
            <div id="summaryText">No sets recorded</div>
        </div>

        <button class="btn" id="toggleDebugBtn" style="margin-top: 10px; width: 100%;">Toggle Debug</button>
    </div>

    <div id="debugPanel"></div>
    
    <div class="recording-indicator" id="recordingIndicator">üî¥ RECORDING</div>
    <div class="calibration-indicator" id="calibrationIndicator">üü° CALIBRATING</div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA & CONSTANTS ---
            const exercises = {
                chest: { 
                    'bench_press': 'Bench Press', 
                    'dumbbell_press': 'Dumbbell Press', 
                    'incline_dumbbell_press': 'Incline Dumbbell Press', 
                    'cable_flyes': 'Cable Flyes', 
                    'cable_crossover': 'Cable Crossover' 
                },
                back: { 
                    'cable_row': 'Cable Row', 
                    'lat_pulldown': 'Lat Pulldown', 
                    'bent_over_row': 'Bent Over Row' 
                },
                shoulders: { 
                    'shoulder_press': 'Shoulder Press', 
                    'lateral_raises': 'Lateral Raises', 
                    'rear_delts': 'Rear Delts' 
                },
                arms: { 
                    'hammer_curl': 'Hammer Curl', 
                    'bicep_cable': 'Bicep Cable', 
                    'tricep_overhead_extension': 'Tricep Overhead Extension', 
                    'tricep_pushdown': 'Tricep Pushdown' 
                }
            };

            // --- STATE MANAGEMENT ---
            let state = {
                position: null, muscle: null, exercise: null, exerciseName: null,
                plannedReps: 10, actualReps: 10,
                recording: false, calibrating: false,
                sensorData: [], baselineData: [], tempSet: null, allSets: [], startTime: 0,
                setCounter: {} // Track set numbers per exercise
            };
            
            // Check existing files to determine next set number
            function checkExistingFiles(exerciseId) {
                // This is a simple check - in real implementation you'd check actual files
                // For now, we'll use localStorage to track set numbers across sessions
                const key = `setCounter_${exerciseId}`;
                const existingCount = localStorage.getItem(key);
                return existingCount ? parseInt(existingCount) : 0;
            }

            // --- SENSORS & HANDLERS ---
            let sensors = { acc: null, gyro: null, mag: null };
            let handlers = {};

            // --- DOM ELEMENTS ---
            const elements = {
                status: document.getElementById('status'),
                startBtn: document.getElementById('startBtn'),
                muscleGrid: document.getElementById('muscleGrid'),
                exerciseSection: document.getElementById('exerciseSection'),
                exerciseGrid: document.getElementById('exerciseGrid'),
                repSection: document.getElementById('repSection'),
                repDisplay: document.getElementById('repDisplay'),
                postWorkout: document.getElementById('postWorkout'),
                actualRepDisplay: document.getElementById('actualRepDisplay'),
                summaryText: document.getElementById('summaryText'),
                debugPanel: document.getElementById('debugPanel'),
                upperBtn: document.getElementById('upperBtn'),
                forearmBtn: document.getElementById('forearmBtn'),
                toggleDebugBtn: document.getElementById('toggleDebugBtn'),
                recordingIndicator: document.getElementById('recordingIndicator'),
                calibrationIndicator: document.getElementById('calibrationIndicator'),
                errorMessage: document.getElementById('errorMessage')
            };
            
            // --- DEBUGGING ---
            function debugLog(message, type = 'info') {
                const now = new Date();
                const timeStr = `${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}.${String(now.getMilliseconds()).padStart(3,'0')}`;
                const logEntry = document.createElement('div');
                logEntry.className = type;
                logEntry.innerHTML = `<span class="time">[${timeStr}]</span> <span class="info">${message}</span>`;
                elements.debugPanel.appendChild(logEntry);
                elements.debugPanel.scrollTop = elements.debugPanel.scrollHeight;
                if (elements.debugPanel.childElementCount > 50) elements.debugPanel.removeChild(elements.debugPanel.firstElementChild);
            }
            
            // --- INITIALIZATION ---
            function init() {
                debugLog("Initializing application...");
                generateMuscleButtons();
                setupEventListeners();
                initSensors();
                updateUI();
                debugLog("Initialization complete.");
            }

            function generateMuscleButtons() {
                elements.muscleGrid.innerHTML = '';
                Object.keys(exercises).forEach(muscle => {
                    const btn = document.createElement('button');
                    btn.className = 'btn';
                    btn.textContent = muscle.charAt(0).toUpperCase() + muscle.slice(1);
                    btn.dataset.muscle = muscle;
                    elements.muscleGrid.appendChild(btn);
                });
            }
            
            function setupEventListeners() {
                elements.upperBtn.onclick = () => selectPosition('upper_arm');
                elements.forearmBtn.onclick = () => selectPosition('forearm');

                elements.muscleGrid.addEventListener('click', (e) => {
                    if (e.target.dataset.muscle) selectMuscleGroup(e.target.dataset.muscle, e.target);
                });

                elements.exerciseGrid.addEventListener('click', (e) => {
                    const btn = e.target.closest('.btn');
                    if (btn?.dataset.id) selectExercise(btn.dataset.id, btn.dataset.name, btn);
                });
                
                document.getElementById('repMinusBtn').onclick = () => adjustReps(-1);
                document.getElementById('repPlusBtn').onclick = () => adjustReps(1);
                document.getElementById('quickRepBtns').addEventListener('click', (e) => {
                    if (e.target.tagName === 'BUTTON') setReps(parseInt(e.target.textContent));
                });
                elements.startBtn.onclick = toggleRecording;
                document.getElementById('actualRepMinusBtn').onclick = () => adjustActualReps(-1);
                document.getElementById('actualRepPlusBtn').onclick = () => adjustActualReps(1);
                document.getElementById('quickActualRepBtns').addEventListener('click', (e) => {
                    if(e.target.tagName === 'BUTTON') setActualReps(parseInt(e.target.textContent));
                });
                document.getElementById('saveSetBtn').onclick = saveSet;
                elements.toggleDebugBtn.onclick = () => {
                    const isHidden = elements.debugPanel.style.display === 'none';
                    elements.debugPanel.style.display = isHidden ? 'block' : 'none';
                    debugLog(`Debug panel ${isHidden ? 'shown' : 'hidden'}.`);
                };
            }

            async function initSensors() {
                debugLog("Initializing sensors...");
                const options = { frequency: 60 };
                
                try {
                    // Simple sensor initialization without permissions check
                    if ('Accelerometer' in window) {
                        sensors.acc = new Accelerometer(options);
                        sensors.acc.onreading = () => handleReading('acc');
                        sensors.acc.onerror = (e) => debugLog(`Accelerometer error: ${e.error.name}`, 'error');
                        document.getElementById('accDot').className = 'sensor-dot active';
                        debugLog("Accelerometer initialized");
                    }
                    
                    if ('Gyroscope' in window) {
                        sensors.gyro = new Gyroscope(options);
                        sensors.gyro.onreading = () => handleReading('gyro');
                        sensors.gyro.onerror = (e) => debugLog(`Gyroscope error: ${e.error.name}`, 'error');
                        document.getElementById('gyroDot').className = 'sensor-dot active';
                        debugLog("Gyroscope initialized");
                    }
                    
                    if ('Magnetometer' in window) {
                        sensors.mag = new Magnetometer(options);
                        sensors.mag.onreading = () => handleReading('mag');
                        sensors.mag.onerror = (e) => debugLog(`Magnetometer error: ${e.error.name}`, 'error');
                        document.getElementById('magDot').className = 'sensor-dot active';
                        debugLog("Magnetometer initialized");
                    }
                    
                    // Check if any sensors are available
                    if (!sensors.acc && !sensors.gyro && !sensors.mag) {
                        debugLog("No sensors available", 'error');
                        elements.errorMessage.style.display = 'block';
                    } else {
                        debugLog("Sensors initialized successfully");
                        elements.errorMessage.style.display = 'none';
                    }
                } catch (e) {
                    debugLog(`Sensor initialization failed: ${e.message}`, 'error');
                    elements.errorMessage.style.display = 'block';
                }
            }

            // --- UI & STATE FUNCTIONS ---
            function selectPosition(pos) {
                state.position = pos;
                debugLog(`Position selected: ${pos}`);
                elements.upperBtn.classList.toggle('selected', pos === 'upper_arm');
                elements.forearmBtn.classList.toggle('selected', pos === 'forearm');
                updateUI();
            }

            function selectMuscleGroup(muscle, btn) {
                state.muscle = muscle;
                state.exercise = null; state.exerciseName = null;
                debugLog(`Muscle group selected: ${muscle}`);
                document.querySelectorAll('#muscleGrid .btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');

                elements.exerciseGrid.innerHTML = '';
                const muscleExercises = exercises[muscle];
                for (const [id, name] of Object.entries(muscleExercises)) {
                    const exBtn = document.createElement('button');
                    exBtn.className = 'btn'; exBtn.textContent = name;
                    exBtn.dataset.id = id; exBtn.dataset.name = name;
                    elements.exerciseGrid.appendChild(exBtn);
                }
                elements.exerciseSection.style.display = 'block';
                elements.repSection.style.display = 'none';
                updateUI();
            }

            function selectExercise(id, name, btn) {
                state.exercise = id;
                state.exerciseName = name;
                debugLog(`Exercise selected: ${name} (${id})`);
                document.querySelectorAll('#exerciseGrid .btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                elements.repSection.style.display = 'block';
                updateUI();
            }

            function adjustReps(delta) {
                state.plannedReps = Math.max(1, state.plannedReps + delta);
                state.actualReps = state.plannedReps;
                elements.repDisplay.textContent = state.plannedReps;
                updateUI();
            }

            function setReps(count) {
                state.plannedReps = count;
                state.actualReps = count;
                elements.repDisplay.textContent = count;
                updateUI();
            }

            function adjustActualReps(delta) {
                state.actualReps = Math.max(1, state.actualReps + delta);
                elements.actualRepDisplay.textContent = state.actualReps;
            }

            function setActualReps(count) {
                state.actualReps = count;
                elements.actualRepDisplay.textContent = count;
            }

            function updateUI() {
                const ready = state.position && state.muscle && state.exercise;
                elements.startBtn.disabled = !ready;
                if (state.recording) {
                    elements.startBtn.textContent = 'STOP RECORDING';
                    elements.startBtn.className = 'btn red recording';
                } else if (ready) {
                    elements.startBtn.textContent = `START SET`;
                    elements.startBtn.className = 'btn green';
                } else {
                    elements.startBtn.textContent = 'SELECT CONFIGURATION';
                    elements.startBtn.className = 'btn';
                }
                elements.status.textContent = ready ?
                    `Ready: ${state.exerciseName} - ${state.position.replace('_', ' ')} (${state.plannedReps} reps)`:
                    'Select Position & Muscle Group';
                elements.summaryText.textContent = state.allSets.length > 0 ? `${state.allSets.length} set(s) recorded` : 'No sets recorded';
                
                // Update indicators
                elements.recordingIndicator.style.display = state.recording ? 'block' : 'none';
            }

            // --- RECORDING & SENSOR HANDLING ---
            function handleReading(sensorKey) {
                const handler = handlers[sensorKey];
                if (handler) handler();
            }

            async function toggleRecording() {
                if (state.recording) stopRecording();
                else await startRecordingSequence();
            }
            
            async function startRecordingSequence() {
                debugLog("Starting recording sequence...");
                
                // Start sensors first to ensure they're ready
                debugLog("Activating sensors...");
                Object.values(sensors).forEach(s => {
                    if (s) {
                        try {
                            s.start();
                            debugLog("Sensor started");
                        } catch (e) {
                            debugLog(`Failed to start sensor: ${e.message}`, 'error');
                        }
                    }
                });
                
                // Small delay to ensure gyroscope is active
                await new Promise(resolve => setTimeout(resolve, 500));
                debugLog("Sensors activated, starting recording...");
                
                // Start recording
                state.recording = true;
                state.sensorData = [];
                state.startTime = Date.now();
                updateUI();
                elements.status.textContent = `RECORDING...`;
                navigator.vibrate?.(200);
                debugLog(`Recording started for ${state.exerciseName}.`);
            }
            
            // Baseline collection removed - we capture all real-world noise now

            function createDataPoint(startTime) {
                const dataPoint = { t: Date.now() - startTime };
                if (sensors.acc?.x != null) { 
                    dataPoint.ax = sensors.acc.x; 
                    dataPoint.ay = sensors.acc.y; 
                    dataPoint.az = sensors.acc.z; 
                }
                if (sensors.gyro?.x != null) { 
                    dataPoint.gx = sensors.gyro.x; 
                    dataPoint.gy = sensors.gyro.y; 
                    dataPoint.gz = sensors.gyro.z; 
                }
                if (sensors.mag?.x != null) { 
                    dataPoint.mx = sensors.mag.x; 
                    dataPoint.my = sensors.mag.y; 
                    dataPoint.mz = sensors.mag.z; 
                }
                return dataPoint;
            }

            function stopRecording() {
                debugLog("Stopping recording...");
                state.recording = false;
                const recordingHandler = () => state.sensorData.push(createDataPoint(state.startTime));
                Object.keys(sensors).forEach(key => handlers[key] = recordingHandler);

                setTimeout(() => {
                    Object.values(sensors).forEach(s => {
                        if (s) {
                            try {
                                s.stop();
                            } catch (e) {
                                debugLog(`Failed to stop sensor: ${e.message}`, 'error');
                            }
                        }
                    });
                    Object.keys(sensors).forEach(key => handlers[key] = null);

                    state.tempSet = {
                        setId: 'set_' + Date.now(), 
                        exerciseId: state.exercise, 
                        exerciseName: state.exerciseName, 
                        phonePosition: state.position,
                        plannedReps: state.plannedReps, 
                        recordingDuration: Date.now() - state.startTime,
                        sensorData: [...state.sensorData],
                    };
                    elements.actualRepDisplay.textContent = state.actualReps;
                    elements.postWorkout.classList.add('show');
                    updateUI();
                    navigator.vibrate?.([100, 50, 100]);
                    debugLog(`Recording stopped. Samples: ${state.sensorData.length}. Awaiting rep confirmation.`);
                }, 100);
            }

            // --- DATA MANAGEMENT ---
            function getNextSetNumber(exerciseId) {
                // Check existing files first
                const existingCount = checkExistingFiles(exerciseId);
                
                // Use the higher of existing count or current session count
                const currentCount = state.setCounter[exerciseId] || 0;
                const nextNumber = Math.max(existingCount, currentCount) + 1;
                
                // Update both session counter and localStorage
                state.setCounter[exerciseId] = nextNumber;
                localStorage.setItem(`setCounter_${exerciseId}`, nextNumber.toString());
                
                debugLog(`Set number for ${exerciseId}: ${nextNumber} (existing: ${existingCount}, current: ${currentCount})`);
                return nextNumber;
            }

            function exportSetToFile(setObject) {
                if (!setObject) {
                    debugLog("No set object to export", 'error');
                    return;
                }
                
                const setNumber = getNextSetNumber(setObject.exerciseId);
                const fileName = `${setObject.exerciseId}_set${setNumber}.json`;
                
                // Create the JSON data with proper structure for training
                const jsonData = {
                    exercise: setObject.exerciseId,
                    exercise_name: setObject.exerciseName,
                    reps: setObject.actualReps,
                    planned_reps: setObject.plannedReps,
                    phone_position: setObject.phonePosition,
                    recording_duration: setObject.recordingDuration,
                    session_time: setObject.sessionTime,
                    set_number: setNumber,
                    data: setObject.sensorData
                };
                
                const dataStr = JSON.stringify(jsonData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.download = fileName;
                a.href = url;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                debugLog(`Set exported: ${fileName}`);
            }

            function saveSet() {
                debugLog('Save button clicked');
                if (!state.tempSet) {
                    debugLog('No temp set to save!', 'error');
                    return;
                }
                
                state.tempSet.actualReps = state.actualReps;
                state.tempSet.sessionTime = new Date().toISOString();
                
                debugLog(`Saving set: ${state.tempSet.exerciseName} with ${state.actualReps} reps`);
                
                // Keep set in memory for summary
                state.allSets.push(state.tempSet);

                // Export individual set file
                exportSetToFile(state.tempSet);
                
                debugLog(`Set saved & downloaded: ${state.tempSet.exerciseName} - ${state.tempSet.actualReps} reps.`);
                
                state.tempSet = null; // Clear the temporary set
                elements.postWorkout.classList.remove('show');
                elements.status.textContent = 'Set saved! Ready for next one.';
                updateUI();
                navigator.vibrate?.(300);
            }
            
            // Discard function removed - no longer needed

            init();
        });
    </script>
</body>
</html>
