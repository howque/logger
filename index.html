<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Workout Data Logger - CNN Training</title>
    <style>
        :root { --accent-color: #0066cc; --record-color: #cc0000; --save-color: #009900; }
        body { font-family: Arial, sans-serif; background: #1a1a1a; color: #ffffff; margin: 0; padding: 20px; text-align: center; font-size: 18px; }
        .container { max-width: 100%; margin: 0 auto; display: flex; flex-direction: column; min-height: calc(100vh - 40px); }
        h2 { margin: 10px 0 15px; font-size: 24px; }
        .muscle-tabs { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; }
        .muscle-tab { background: #333; color: #fff; border: 3px solid #555; padding: 20px; border-radius: 12px; cursor: pointer; font-size: 20px; font-weight: bold; }
        .muscle-tab.active { background: var(--accent-color); border-color: var(--accent-color); }
        .exercise-grid { display: grid; grid-template-columns: 1fr; gap: 15px; margin-bottom: 25px; }
        .exercise-btn { background: #333; color: #fff; border: 3px solid #555; padding: 25px 15px; border-radius: 12px; cursor: pointer; font-size: 18px; font-weight: bold; }
        .exercise-btn.selected { background: var(--save-color); border-color: var(--save-color); }
        #status { font-size: 22px; margin-bottom: 15px; padding: 15px; background: #2a2a2a; border-radius: 12px; min-height: 30px; }
        #startBtn { background: var(--save-color); color: white; border: none; padding: 30px; border-radius: 15px; font-size: 24px; font-weight: bold; cursor: pointer; width: 100%; min-height: 100px; transition: background-color 0.3s; }
        #startBtn:disabled { background: #666; color: #999; }
        #startBtn.recording { background: var(--record-color); animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .action-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 25px; }
        .action-btn { background: #444; color: #fff; border: 2px solid #666; padding: 20px 15px; border-radius: 12px; cursor: pointer; font-size: 16px; font-weight: bold; }
        .sensor-status { background: #2a2a2a; border-radius: 12px; padding: 15px; margin-top: auto; font-size: 16px; }
        .sensor-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 10px; }
        .sensor-active { background: #00cc00; } .sensor-inactive { background: #cc0000; }
        .summary { background: #2a2a2a; border-radius: 12px; padding: 15px; margin-top: 15px; text-align: left; font-size: 16px; }
        
        /* --- Workout Mode for Armband Use --- */
        #changeExerciseBtn { display: none; background: var(--accent-color); margin-top: 15px; }
        .container.workout-mode { justify-content: center; }
        .container.workout-mode .muscle-tabs, .container.workout-mode .exercise-grid,
        .container.workout-mode .action-buttons, .container.workout-mode .summary, 
        .container.workout-mode .sensor-status, .container.workout-mode h2 {
            display: none;
        }
        .container.workout-mode #status { margin-top: 0; }
        .container.workout-mode #startBtn { height: 50vh; font-size: 36px; }
        .container.workout-mode #changeExerciseBtn { display: block; }
    </style>
</head>
<body>
    <div class="container" id="container">
        <h2>ðŸ’ª Data Logger</h2>
        <div class="muscle-tabs" id="muscleTabs"></div>
        <div id="status">Select Exercise</div>
        <div class="exercise-grid" id="exerciseGrid"></div>
        <button id="startBtn" disabled>SELECT EXERCISE</button>
        <button class="action-btn" id="changeExerciseBtn">Change Exercise</button>
        <div class="action-buttons">
            <button class="action-btn" id="exportAllBtn" style="display:none;">EXPORT ALL</button>
            <button class="action-btn" id="clearBtn">CLEAR SESSION</button>
        </div>
        <div class="action-buttons">
            <button class="action-btn" id="resetBtn" style="background: #cc0000;">RESET ALL NUMBERS</button>
            <button class="action-btn" id="viewCountsBtn">VIEW COUNTS</button>
        </div>
        <div class="summary" id="summary"></div>
        <div class="sensor-status">
            <div><span class="sensor-indicator" id="accIndicator"></span>Accelerometer</div>
            <div style="margin-top: 8px;"><span class="sensor-indicator" id="gyroIndicator"></span>Gyroscope</div>
        </div>
    </div>

    <script>
        // --- Configuration & Data ---
        const exercises = {
            chest: [{ id: 'bench_press', name: 'Bench Press' }, { id: 'incline_press', name: 'Incline Press' }, { id: 'dumbbell_press', name: 'Dumbbell Press' }],
            back: [{ id: 'deadlift', name: 'Deadlift' }, { id: 'pull_ups', name: 'Pull Ups' }, { id: 'barbell_row', name: 'Barbell Row' }],
            shoulders: [{ id: 'shoulder_press', name: 'Shoulder Press' }, { id: 'lateral_raise', name: 'Lateral Raise' }, { id: 'rear_delt_fly', name: 'Rear Delt Fly' }],
            arms: [{ id: 'bicep_curl', name: 'Bicep Curl' }, { id: 'hammer_curl', name: 'Hammer Curl' }, { id: 'tricep_extension', name: 'Tricep Extension' }],
            legs: [{ id: 'squat', name: 'Squat' }, { id: 'leg_press', name: 'Leg Press' }, { id: 'lunges', name: 'Lunges' }]
        };

        // --- State ---
        let isRecording = false, isWorkoutMode = false;
        let selectedExercise = null, sensorData = [], sessionSets = [];
        let accelerometer, gyroscope, sensorReadHandler;
        let setCounts = JSON.parse(localStorage.getItem('workoutSetCounts') || '{}');

        // --- DOM Elements & Helpers ---
        const D = id => document.getElementById(id);
        const ui = { container: D('container'), muscleTabs: D('muscleTabs'), exerciseGrid: D('exerciseGrid'), startBtn: D('startBtn'), status: D('status'), summary: D('summary'), accIndicator: D('accIndicator'), gyroIndicator: D('gyroIndicator'), exportAllBtn: D('exportAllBtn') };
        const allExercisesById = Object.values(exercises).flat().reduce((acc, ex) => (acc[ex.id] = ex, acc), {});
        const saveCounts = () => localStorage.setItem('workoutSetCounts', JSON.stringify(setCounts));
        const speak = text => 'speechSynthesis' in window && speechSynthesis.speak(new SpeechSynthesisUtterance(text));
        const vibrate = pattern => navigator.vibrate?.(pattern);
        const download = (data, filename) => {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' }));
            a.download = filename; a.click(); URL.revokeObjectURL(a.href);
        };

        // --- UI Rendering ---
        function updateUI() {
            ui.container.classList.toggle('workout-mode', isWorkoutMode);
            ui.startBtn.classList.toggle('recording', isRecording);
            ui.startBtn.disabled = !selectedExercise || isRecording;
            if (isRecording) ui.startBtn.textContent = 'STOP';
            else if (selectedExercise) ui.startBtn.textContent = 'START';
            else ui.startBtn.textContent = 'SELECT EXERCISE';
            ui.status.textContent = isRecording ? 'RECORDING...' : (selectedExercise ? `Ready: ${selectedExercise.name}` : 'Select Exercise');
            const hasSets = sessionSets.length > 0;
            ui.exportAllBtn.style.display = hasSets ? 'inline-block' : 'none';
            if (!hasSets) ui.summary.innerHTML = '<div><strong>Session:</strong> No data collected</div>';
            else {
                const totalSamples = sessionSets.reduce((sum, set) => sum + set.sample_count, 0);
                const uniqueExercises = [...new Set(sessionSets.map(s => s.exercise_name))];
                ui.summary.innerHTML = `<div><strong>Session:</strong> ${sessionSets.length} sets</div><div><strong>Exercises:</strong> ${uniqueExercises.join(', ')}</div><div><strong>Total:</strong> ${totalSamples.toLocaleString()} samples</div>`;
            }
        }

        function renderExercises(muscle) {
            ui.muscleTabs.querySelectorAll('.muscle-tab').forEach(t => t.classList.toggle('active', t.dataset.muscle === muscle));
            ui.exerciseGrid.innerHTML = exercises[muscle].map(ex => `<button class="exercise-btn" data-exercise-id="${ex.id}">${ex.name}</button>`).join('');
        }

        // --- Core Logic ---
        function selectMuscle(muscle) {
            isWorkoutMode = false; selectedExercise = null;
            renderExercises(muscle); updateUI();
        }

        function selectExercise(exerciseId) {
            selectedExercise = allExercisesById[exerciseId] || null;
            isWorkoutMode = true;
            ui.exerciseGrid.querySelectorAll('.exercise-btn').forEach(b => b.classList.toggle('selected', b.dataset.exerciseId === exerciseId));
            updateUI();
            speak(`Ready for ${selectedExercise.name}`);
        }

        function startRecording() {
            if (!selectedExercise || !accelerometer) return;
            isRecording = true; sensorData = [];
            const startTime = Date.now();
            sensorReadHandler = () => {
                const dataPoint = { t: Date.now() - startTime, ax: accelerometer.x, ay: accelerometer.y, az: accelerometer.z };
                if (gyroscope?.x) Object.assign(dataPoint, { gx: gyroscope.x, gy: gyroscope.y, gz: gyroscope.z });
                sensorData.push(dataPoint);
            };
            accelerometer.addEventListener('reading', sensorReadHandler);
            gyroscope?.addEventListener('reading', sensorReadHandler);
            accelerometer.start(); gyroscope?.start();
            vibrate(200); speak('Recording');
            updateUI();
        }

        function stopRecording() {
            if (!isRecording) return;
            isRecording = false;
            accelerometer?.removeEventListener('reading', sensorReadHandler);
            gyroscope?.removeEventListener('reading', sensorReadHandler);
            accelerometer?.stop(); gyroscope?.stop();

            if (sensorData.length < 100) {
                ui.status.textContent = 'TOO SHORT';
                vibrate([100, 50, 100]); speak('Recording too short');
            } else {
                const { id: exerciseId, name: exerciseName } = selectedExercise;
                setCounts[exerciseId] = (setCounts[exerciseId] || 0) + 1;
                saveCounts();
                const setData = { exercise_id: exerciseId, exercise_name: exerciseName, set_number: setCounts[exerciseId], timestamp: new Date().toISOString(), sample_count: sensorData.length, has_gyroscope: !!gyroscope, data: sensorData };
                sessionSets.push(setData);
                download(setData, `${exerciseId}_set${setCounts[exerciseId]}.json`);
                ui.status.textContent = 'SAVED!';
                vibrate(300); speak('Set saved');
            }
            setTimeout(updateUI, 2000);
        }

        async function initSensors() {
            const setup = async (name, indicator) => {
                try {
                    if (name in window) {
                        const sensor = new window[name]({ frequency: 60 });
                        indicator.className = 'sensor-indicator sensor-active';
                        return sensor;
                    }
                } catch (error) { console.error(`${name} setup failed:`, error); }
                indicator.className = 'sensor-indicator sensor-inactive';
                return null;
            };
            [accelerometer, gyroscope] = await Promise.all([setup('Accelerometer', ui.accIndicator), setup('Gyroscope', ui.gyroIndicator)]);
        }

        // --- Initial Setup ---
        function init() {
            ui.muscleTabs.innerHTML = Object.keys(exercises).map(m => `<button class="muscle-tab" data-muscle="${m}">${m.toUpperCase()}</button>`).join('');
            ui.muscleTabs.addEventListener('click', e => e.target.matches('.muscle-tab') && selectMuscle(e.target.dataset.muscle));
            ui.exerciseGrid.addEventListener('click', e => e.target.matches('.exercise-btn') && selectExercise(e.target.dataset.exerciseId));
            
            D('startBtn').onclick = () => (isRecording ? stopRecording() : startRecording());
            D('changeExerciseBtn').onclick = () => selectMuscle(document.querySelector('.muscle-tab.active')?.dataset.muscle || 'chest');
            D('exportAllBtn').onclick = () => sessionSets.length && download({ session_timestamp: new Date().toISOString(), total_sets: sessionSets.length, sets: sessionSets }, `session_${Date.now()}.json`);
            D('clearBtn').onclick = () => {
                if (sessionSets.length > 0 && confirm('Clear all data from this session? (Set counts will be kept)')) {
                    sessionSets = []; updateUI(); ui.status.textContent = 'Session data cleared.';
                }
            };
            D('resetBtn').onclick = () => {
                if (confirm('RESET ALL DATA? This will delete all saved set numbers and session data!')) {
                    sessionSets = []; setCounts = {}; saveCounts(); updateUI(); ui.status.textContent = 'All data has been reset.';
                }
            };
            D('viewCountsBtn').onclick = () => {
                const message = Object.entries(setCounts).map(([id, count]) => `${allExercisesById[id]?.name || id}: ${count} sets`).join('\n');
                alert(Object.keys(setCounts).length ? 'Current Set Numbers:\n\n' + message : 'No exercises recorded yet.');
            };
            initSensors();
            selectMuscle('chest');
        }

        // Start the application
        init();
    </script>
</body>
</html>
